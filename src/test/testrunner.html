<html>
  <head>
  <style>
    body { padding:  0; margin: 0; font-family: "Monaco PT", monospace; font-size: 13px; line-height: 20px;}
    .test {padding: 0px 10px 0px 10px;}
    .test-success { background: #EBEBC7; color: #57561D;}
    .test-failure { background: #FF964F; color: #990700;}
    select {margin: 10px; }
    .result { background: red; color: #fff; margin: 5px;}
    .result div {background: #5F8C46; height: 10px}
    .note {padding:10px 30px 10px 25px; font-family:sans-serif;}
  </style>
  <script type="text/javascript" src="../oni-apollo.js"></script>
  <script type="text/sjs">
    require.path="../modules/";
  /*
  try {
    var r = createXMLHttpRequest();
    r.open("GET", "testrunner.html?cachebust="+Math.random(), false);
    r.send(null);
    dump(r.getResponseHeader("Server"));
    var isRocket = r.getResponseHeader("Server").indexOf("oni_rocket") == 0;
  }
  catch (e) {
    dump("Could not determine whether server is Rocket:"+e);
    throw new Error("Could not determine whether server is Rocket:"+e);
  }
  */
  var suites = [
    "sjs-testsuite.sjs",
    "require-tests.sjs",
    "cutil-tests.sjs",
    "http-tests.sjs",
    "jquery-tests.sjs",
    "dom-tests.sjs",
    "google-tests.sjs",
    "common-tests.sjs",
    "yql-tests.sjs",
    "perf-tests.sjs"
  ];

function pad (id) {
  var rv="";
  var l = 6 - (""+id).length;
  for (;l--;) rv+="&nbsp;";
  return id+rv;
}

var failureCount = 0;
var testCounter = 0;

function dump(x) {
  document.getElementById('output').innerHTML += x;
}

function dumpSuccess(id, x, result) {
  document.getElementById('output').innerHTML += '<div class="test test-success">&nbsp;&nbsp;'+pad(id)+''+x+' ---> '+result+'</div>';
}

function dumpFailure(id, x, resultA, resultB) {
  ++failureCount;
  document.getElementById('output').innerHTML += '<div class="test test-failure">&#9679;&nbsp;'+pad(id)+''+x+' ---> '+resultA+' != '+resultB+'</div>';
}

function test(name, expected, f) {
  try {
    var a = f();
  } catch (e) {
    var error = e;
  }
  if (a === expected)
    dumpSuccess(++testCounter, name, a);
  else
    dumpFailure(++testCounter, name, a + (error?" (Exception: "+error+")":""), expected);
}

function testParity(exp, f) {
  try {
    var a = eval(exp);
  }
  catch (e) {
    a = e;
  }
  try {
    var b = f();
  }
  catch (e) {
    b = e;
  }
  if (a === b)
    dumpSuccess(++testCounter, exp, a);
  else
    dumpFailure(++testCounter, exp, a, b);
}

function time(name, f) {
  try {
    var start = new Date();
    f();
    var duration = (new Date()) - start;
  }
  catch (e) {
    dumpFailure(++testCounter, name, e, "success");
    return;
  }
  dumpSuccess(++testCounter, name, duration + "ms");
  hold(0);
}

function createXMLHttpRequest() {
  try {
    return new XMLHttpRequest();
  } catch(e) {}
  try {
    return new ActiveXObject("Msxml2.XMLHTTP");
  } catch(e) {}
  throw "XMLHttpRequest not supported by your browser";
}

function loadScript(src,accumulate) {
  if (!accumulate) {
    document.getElementById('output').innerHTML = "";
    location.hash = src;
    failureCount = 0;
    testCounter = 0;
  }
  if (src=="All") {
    for (var i = 0, suite; suite = suites[i]; ++i) {
      loadScript(suite, true);
    }

  } else {
/*  if (isRocket) src+="[src]"; */
  dump("<div class='note'>Loading <a href='"+src+"'>"+src+"</a></div>");
  var r = createXMLHttpRequest();
  r.open("GET", src+"?cachebust="+Math.random(), true);
  if (r.overrideMimeType)
    r.overrideMimeType("text/plain");
  waitfor() {
    r.onreadystatechange = function(evt) {
      if (r.readyState != 4) return;
      resume();
    };
    r.send(null);  
  }
  retract {
    r.abort();
  }
  if (r.status != 200) {
    var errorText = "Error loading "+src+": "+r.status+"  "+r.statusText;
    dump(errorText);
    throw new Error(errorText);
  }
  require('sjs:apollo-sys').eval("window.tests = (function(){" + r.responseText + "})", {filename:src});
  window.tests();
  }
  if (!accumulate) {
    var p = 100 - Math.round(failureCount * 100 /  testCounter);
    document.getElementById("bar").innerHTML = "<div class='result'><div style='width:"+p+"%'></div></div>";
    dump("<div class='note'>Finished</div>");
  }
}

var hash = location.hash.split("#")[1];
var currentSuite = hash || suites[0];

function addOption(suite) {
  var el = document.createElement("option");
  el.textContent = suite;
  el.innerText = suite;
  if (suite == currentSuite) el.setAttribute("selected", "selected");
  el.setAttribute("value", suite);
  select.appendChild(el);
}

var select = document.getElementById("select");
for (var i = 0, suite; suite = suites[i]; ++i) {
  addOption(suite);
}
addOption("All");
// this is just to get select to resize on IE:
var pn = select.parentNode;
pn.removeChild(select);
pn.appendChild(select);

while (true) {
  waitfor {
    loadScript(currentSuite);
    hold();
  }
  or {
    require('dom').waitforEvent("select", "change");
    currentSuite = document.getElementById("select").value;
  }
}

</script>
  </head>
  <body>
    <table><tr><td>
    <select xonchange="loadScript(this.value)" id="select">
    </select>
    </td><td style="width:100%">
    <div id="bar"></div>
    </td></tr></table>
    <div id="output">
      
    </div>
  </body>
</html>
